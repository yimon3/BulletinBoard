@model BulletinBoardSampleFrame.ViewModel.Login.LoginModel
@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script type="text/javascript">
        var OAUTHURL = 'https://accounts.google.com/o/oauth2/auth?';
        var VALIDURL = 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=';
        var SCOPE = 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
        var CLIENTID = '341560011525-q7311qvki2i0m34d3aum6fb30v9qbslo.apps.googleusercontent.com';
        var REDIRECT = 'https://localhost:44323/';
        var LOGOUT = 'https://localhost:44323/';
        var TYPE = 'token';
        var _url = OAUTHURL + 'scope=' + SCOPE + '&client_id=' + CLIENTID + '&redirect_uri=' + REDIRECT + '&response_type=' + TYPE;
        var acToken;
        var tokenType;
        var expiresIn;
        var user;
        var loggedIn = false;

        function login() {

            var win = window.open(_url, "windowname1", 'width=1800, height=1600');
            var pollTimer = window.setInterval(function () {
                try {
                    console.log(win.document.URL);
                    if (win.document.URL.indexOf(REDIRECT) != -1) {
                        window.clearInterval(pollTimer);
                        var url = win.document.URL;
                        acToken = gup(url, 'access_token');
                        tokenType = gup(url, 'token_type');
                        expiresIn = gup(url, 'expires_in');

                        win.close();
                        debugger;
                        validateToken(acToken);
                    }
                }
                catch (e) {

                }
            }, 500);
        }

        function gup(url, name) {
            namename = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\#&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(url);
            if (results == null)
                return "";
            else
                return results[1];
        }

        function validateToken(token) {
            getUserInfo();
            $.ajax(
                {
                    url: VALIDURL + token,
                    data: null,
                    success: function (responseText) {
                    },
                });
        }

        function getUserInfo() {
            $.ajax({

                url: 'https://www.googleapis.com/oauth2/v1/userinfo?access_token=' + acToken,
                data: null,
                success: function (resp) {
                    user = resp;
                    console.log(user);
                    $('#uname').html('Welcome ' + user.name);
                    $('#uemail').html('Email: ' + user.email)
                    $('#imgHolder').attr('src', user.picture);
                },
            }),

            $.ajax({

                url: '/Post/GoogleUserList/',

                type: 'POST',
                data: {
                    email: user.email,
                    name: user.name,
                    gender: user.gender,
                    lastname: user.lastname,
                    location: user.location
                },
                success: function () {
                    window.location.href = "/Login/Login/";
                },

                //dataType: "jsonp"

            });
        }

    </script>
    <title>@ViewBag.Title - SCM Bulletin Board</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <div class="container-fluid">
        <h1>SCM Bulletin Board</h1>
        <h3>Log In.</h3>
        <div class="row">
            <div class="col-md-8">
                <section id="loginForm">
                    <h4>Use local Account To Login</h4>
                    <hr />
                    @using (Html.BeginForm("Validate", "Login", FormMethod.Post))
                    {
                        <div class="form-group">
                            @Html.LabelFor(m => m.Email, new { @class = "col-md-2 control-label" })
                            <div class="col-sm-5">
                                @Html.TextBoxFor(m => m.Email, new { @class = "form-control", required = "required" })
                                @Html.HiddenFor(m => m.Email)
                            </div>
                            <label style="color: red">*</label>
                            @Html.ValidationMessageFor(m => m.Email, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            @Html.LabelFor(m => m.Password, new { @class = "col-md-2 control-label" })
                            <div class="col-sm-5">
                                @if (Request.Cookies["Password"] == null)
                                {
                                    @Html.PasswordFor(m => m.Password, new { @class = "form-control", required = "required" }) }
                                else
                                {
                                    @Html.PasswordFor(m => m.Password, new { value = Model.Password, @class = "form-control", required = "required" })
                                }
                                @Html.HiddenFor(m => m.Password)
                            </div>
                            <label style="color: red">*</label>
                            @Html.ValidationMessageFor(m => m.Password, "", new { @class = "text-danger" })
                        </div>
                        <div class="form-group">
                            <div class="col-md-offset-2 col-sm-5">
                                <div class="checkbox">
                                    @Html.CheckBoxFor(m => m.RememberMe)
                                    @Html.LabelFor(m => m.RememberMe)
                                </div>
                            </div>
                        </div>
                        <p class="col-md-10">
                            @Html.ActionLink("Forgot your password?", "ForgotPassword", "Login")
                        </p>
                        <div class="form-group">
                            <div class="col-md-offset-2 col-md-10">
                                <input type="submit" value="Log in" class="btn btn-primary" />
                            </div>
                        </div>
                    }
                </section>
            </div>
            <div class="col-md-4">
                <section id="socialLoginForm">
                    <h4>Use Another Service To Login</h4>
                    <hr />
                    <div class="col">
                        <input type="button" id="googleplus" class="btn btn-default" onclick="login()" value="Google" />
                        <input type="button" class="btn btn-default" onclick="location.href='@Url.Action("TwitterAuth", "Login", FormMethod.Get)'" value="Twitter" />
                        <br />
                        <div id="uname"></div>
                        <div id="uemail"></div>
                    </div>
                </section>
            </div>
        </div>
        <div class="container body-content">
            <hr />
            <footer>
                <p>&copy; @DateTime.Now.Year - SCM Bulletin Board</p>
            </footer>
        </div>
    </div>
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
</body>
</html>



